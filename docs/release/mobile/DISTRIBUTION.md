# Mobile Distribution Workflow

This guide documents how to generate signed mobile artifacts for the Capacitor
client app and how to deliver them to TestFlight and the Google Play internal
testing track.

## Prerequisites

1. **Expo access**
   - Service account or bot user with access to the `ibimina` Expo organization.
   - `EAS_TOKEN` configured in the shell session running the commands below.
2. **Apple credentials**
   - App Store Connect API key stored at
     `apps/client/credentials/appstore_connect.json` (see `fastlane/Appfile`).
   - Apple Developer portal access for bundle `rw.ibimina.sacco`.
3. **Google Play credentials**
   - Service account JSON at
     `apps/client/credentials/google-play-service-account.json`.
   - Permission to upload to the Play Console project.
4. **Environment variables**
   - `EAS_PROJECT_ID_MOBILE` and `EAS_PROJECT_ID_SACCO` for the Expo projects.
   - `EXPO_PUBLIC_API_BASE_URL_MOBILE` / `EXPO_PUBLIC_API_BASE_URL_SACCO` for
     build-time API targets.
   - Optional submit variables `EAS_SUBMIT_IOS_APP_ID_MOBILE` and
     `EAS_SUBMIT_IOS_APP_ID_SACCO` if submit workflows are used.

> ℹ️ When running inside CI, provide the variables through repository or
> environment secrets.

## Generating artifacts

All commands are executed from the repository root unless stated otherwise.

### iOS (TestFlight)

```bash
cd apps/client
fastlane ios release
```

The lane performs the following:

1. Builds the Expo project with the `production` profile (`eas build --wait`).
2. Downloads the signed `.ipa` into
   `apps/client/dist/releases/ios/production/client-production.ipa`.
3. Submits the artifact to TestFlight using `eas submit`.

Artifacts for `internal` and `alpha` lanes are also stored under
`dist/releases/ios/<profile>/` for manual installation or archival.

### Android (Internal testing)

```bash
cd apps/client
fastlane android release
```

The lane builds the `production` profile and places the signed `.aab` at
`apps/client/dist/releases/android/production/client-production.aab`. The same
directory layout is used for `internal` and `alpha` lanes.

Uploads are handled through `fastlane supply`:

- `internal` → Play Console internal testing track.
- `alpha` → Play Console closed testing track.
- `release` → Production track.

## Validating Expo/EAS configuration

CI executes `expo-doctor` for both Expo applications (`apps/mobile` and
`apps/sacco-plus-client`) to make sure native configuration and dependency
versions remain compatible with EAS builds. See `.github/workflows/mobile.yml`
for details.

## Artifact archival

Artifacts generated by the Fastlane lanes are automatically versioned by profile
and platform:

```
apps/client/dist/releases/
  ├── android/
  │   ├── internal/client-internal.aab
  │   ├── alpha/client-alpha.aab
  │   └── production/client-production.aab
  └── ios/
      ├── internal/client-internal.ipa
      ├── alpha/client-alpha.ipa
      └── production/client-production.ipa
```

Because the `dist/` directory is git-ignored, copy any artifacts that must be
persisted to an external storage location (S3 bucket, internal NAS, etc.) after
the Fastlane run completes.

## Post-release checklist

1. Confirm TestFlight processing completed and invite the appropriate tester
   group.
2. Promote the Play Store internal build to alpha or production as required.
3. Tag the commit in Git with the released versions for traceability.
4. Update release notes in the Play Console and App Store Connect if they were
   skipped during automated upload.
