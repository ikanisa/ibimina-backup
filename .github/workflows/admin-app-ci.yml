name: Admin App CI
on:
  push:
  pull_request:
permissions:
  contents: read

jobs:
  admin-app:
    name: Build, Typecheck, Lint, Test (admin-app)
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: admin-app
    steps:
      - name: Checkout
        uses: actions/checkout@v5
      - name: Setup Node
        uses: actions/setup-node@v5
        with:
          node-version: 18
          cache: 'npm'
          cache-dependency-path: admin-app/package-lock.json
      - name: Install dependencies
        run: npm ci
      - name: Typecheck (API + lib)
        run: npx tsc -p tsconfig.ci.json --noEmit
      - name: Lint
        run: npm run lint --no-update-notifier --no --max-warnings=0
      - name: Run tests
        run: npm test -- --run
      - name: Build
        env:
          # Ensure mocks are off for production-like builds
          NEXT_PUBLIC_USE_MOCKS: 'false'
        run: npm run build

  sql-migrations:
    name: SQL Migrations Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v5
      - name: Setup Deno
        uses: denoland/setup-deno@v2
        with:
          deno-version: v2.x
      - name: Check migration formatting
        run: deno run --allow-read tools/sql/check_migrations.ts

  sql-policy-audit:
    name: SQL Policy Audit
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v5
      - name: Setup Deno
        uses: denoland/setup-deno@v2
        with:
          deno-version: v2.x
      - name: Audit RLS policies
        run: deno run --allow-read tools/sql/policy_audit.ts

  synthetic-checks:
    name: Synthetic Admin Checks
    if: github.event_name != 'pull_request'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v5
      - name: Setup Deno
        uses: denoland/setup-deno@v2
        with:
          deno-version: v2.x
      - name: Run synthetic checks
        env:
          ADMIN_BASE_URL: ${{ secrets.ADMIN_BASE_URL }}
          ADMIN_API_TOKEN: ${{ secrets.ADMIN_API_TOKEN }}
        run: deno run --allow-env --allow-net tools/monitoring/admin/synthetic-checks.ts
