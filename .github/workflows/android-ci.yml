name: Android CI - Pull Request Checks

on:
  pull_request:
    branches: [main, work]
    paths:
      - "apps/pwa/staff-admin/**"
      - "apps/pwa/client/**"
      - "apps/*/android/**"
      - ".github/workflows/android-ci.yml"

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  lint-and-test:
    name: Lint & Test Android Apps
    runs-on: ubuntu-latest
    env:
      CI: "true"
      HUSKY: "0"
      NEXT_PUBLIC_SUPABASE_URL: "https://placeholder.supabase.co"
      NEXT_PUBLIC_SUPABASE_ANON_KEY: "placeholder-anon-key"
      SUPABASE_SERVICE_ROLE_KEY: "placeholder-service-role-key"
      BACKUP_PEPPER: "placeholder-backup-pepper-32-bytes-min"
      MFA_SESSION_SECRET: "placeholder-mfa-session-secret-32b"
      TRUSTED_COOKIE_SECRET: "placeholder-trusted-cookie-secret"
      HMAC_SHARED_SECRET: "placeholder-hmac-shared-secret-32"
      OPENAI_API_KEY: "placeholder-openai-api-key"
      KMS_DATA_KEY_BASE64: "c3R1Yi1rbXMtZGF0YS1rZXktMzItYnl0ZXMtISEhIQ=="
    strategy:
      matrix:
        app: [admin, client]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "pnpm"

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.19.0

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: "17"
          cache: "gradle"

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Enable Gradle build caching
        uses: gradle/actions/setup-gradle@v4

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build shared workspaces
        run: pnpm run build:packages

      - name: Build ${{ matrix.app }} web application
        working-directory: apps/${{ matrix.app }}
        run: pnpm run build

      - name: Sync Capacitor assets
        working-directory: apps/${{ matrix.app }}
        run: npx cap sync android

      - name: Lint Kotlin code (ktlint)
        working-directory: apps/${{ matrix.app }}/android
        run: |
          if [ -f "gradlew" ]; then
            chmod +x gradlew
            ./gradlew ktlintCheck || echo "::warning::ktlint found issues"
          fi

      - name: Run Android Lint
        working-directory: apps/${{ matrix.app }}/android
        run: |
          chmod +x gradlew
          ./gradlew lintDebug

      - name: Run unit tests
        working-directory: apps/${{ matrix.app }}/android
        run: |
          ./gradlew testDebugUnitTest

      - name: Build debug APK
        working-directory: apps/${{ matrix.app }}/android
        run: |
          ./gradlew assembleDebug

      - name: Upload lint report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.app }}-lint-report
          path: apps/${{ matrix.app }}/android/app/build/reports/lint-results-debug.html
          retention-days: 7

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.app }}-test-results
          path: apps/${{ matrix.app }}/android/app/build/test-results/testDebugUnitTest/
          retention-days: 7

      - name: Upload debug APK
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.app }}-debug-apk
          path: apps/${{ matrix.app }}/android/app/build/outputs/apk/debug/*.apk
          retention-days: 7

  instrumentation-tests:
    name: Instrumentation Tests
    runs-on: macos-latest
    if: github.event.pull_request.draft == false
    env:
      CI: "true"
      HUSKY: "0"
      NEXT_PUBLIC_SUPABASE_URL: "https://placeholder.supabase.co"
      NEXT_PUBLIC_SUPABASE_ANON_KEY: "placeholder-anon-key"
      SUPABASE_SERVICE_ROLE_KEY: "placeholder-service-role-key"
      BACKUP_PEPPER: "placeholder-backup-pepper-32-bytes-min"
      MFA_SESSION_SECRET: "placeholder-mfa-session-secret-32b"
      TRUSTED_COOKIE_SECRET: "placeholder-trusted-cookie-secret"
      HMAC_SHARED_SECRET: "placeholder-hmac-shared-secret-32"
      OPENAI_API_KEY: "placeholder-openai-api-key"
      KMS_DATA_KEY_BASE64: "c3R1Yi1rbXMtZGF0YS1rZXktMzItYnl0ZXMtISEhIQ=="
    strategy:
      matrix:
        app: [admin]
        api-level: [29, 33]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "pnpm"

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.19.0

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: "17"
          cache: "gradle"

      - name: Enable Gradle build caching
        uses: gradle/actions/setup-gradle@v4

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build shared workspaces
        run: pnpm run build:packages

      - name: Build ${{ matrix.app }} web application
        working-directory: apps/${{ matrix.app }}
        run: pnpm run build

      - name: Sync Capacitor assets
        working-directory: apps/${{ matrix.app }}
        run: npx cap sync android

      - name: AVD cache
        uses: actions/cache@v4
        id: avd-cache
        with:
          path: |
            ~/.android/avd/*
            ~/.android/adb*
          key: avd-${{ matrix.api-level }}

      - name: Create AVD and generate snapshot for caching
        if: steps.avd-cache.outputs.cache-hit != 'true'
        uses: reactivecircus/android-emulator-runner@v2
        with:
          api-level: ${{ matrix.api-level }}
          arch: x86_64
          force-avd-creation: false
          emulator-options: -no-window -gpu swiftshader_indirect -noaudio -no-boot-anim -camera-back none
          disable-animations: true
          script: echo "Generated AVD snapshot for caching."

      - name: Run instrumentation tests
        uses: reactivecircus/android-emulator-runner@v2
        with:
          api-level: ${{ matrix.api-level }}
          arch: x86_64
          force-avd-creation: false
          emulator-options: -no-snapshot-save -no-window -gpu swiftshader_indirect -noaudio -no-boot-anim -camera-back none
          disable-animations: true
          script: |
            cd apps/${{ matrix.app }}/android
            chmod +x gradlew
            ./gradlew connectedDebugAndroidTest

      - name: Upload instrumentation test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.app }}-instrumentation-results-api${{ matrix.api-level }}
          path: apps/${{ matrix.app }}/android/app/build/reports/androidTests/connected/
          retention-days: 7

  check-status:
    name: Check CI Status
    runs-on: ubuntu-latest
    needs: [lint-and-test]
    if: always()

    steps:
      - name: Check job results
        run: |
          if [ "${{ needs.lint-and-test.result }}" != "success" ]; then
            echo "::error::Lint and test checks failed"
            exit 1
          fi
          echo "All checks passed âœ“"
