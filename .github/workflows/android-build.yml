name: Build Signed Staff Android Bundle

on:
  push:
    branches: [main]
    paths:
      - "apps/pwa/staff-admin/**"
      - ".github/workflows/android-build.yml"
  workflow_dispatch:
    inputs:
      server_url:
        description: "Optional override for the production server URL the bundle should embed."
        required: false
        default: ""

jobs:
  bundle:
    name: Generate signed AAB
    runs-on: ubuntu-latest
    env:
      NODE_ENV: production
      CAPACITOR_SERVER_URL: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.server_url != '' && github.event.inputs.server_url || secrets.STAFF_APP_SERVER_URL }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "pnpm"

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.19.0

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: "17"
          cache: "gradle"

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Enable Gradle build caching
        uses: gradle/actions/setup-gradle@v4

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build shared workspaces
        run: pnpm run build:packages

      - name: Build staff web application
        working-directory: apps/pwa/staff-admin
        run: pnpm run build

      - name: Sync Capacitor assets
        working-directory: apps/pwa/staff-admin
        run: npx cap sync android

      - name: Determine version metadata
        id: version
        run: |
          set -euo pipefail
          VERSION_NAME=$(node -pe "require('./apps/pwa/staff-admin/package.json').version")
          VERSION_CODE=$((10000 + $GITHUB_RUN_NUMBER))
          echo "version_name=$VERSION_NAME" >> "$GITHUB_OUTPUT"
          echo "version_code=$VERSION_CODE" >> "$GITHUB_OUTPUT"

      - name: Decode signing keystore
        env:
          ANDROID_KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
        run: |
          set -euo pipefail
          if [ -z "${ANDROID_KEYSTORE_BASE64}" ]; then
            echo "::error::ANDROID_KEYSTORE_BASE64 secret is missing."
            exit 1
          fi
          mkdir -p apps/pwa/staff-admin/android/app
          echo "${ANDROID_KEYSTORE_BASE64}" | base64 --decode > apps/pwa/staff-admin/android/app/release.keystore
          chmod 600 apps/pwa/staff-admin/android/app/release.keystore

      - name: Build signed Android App Bundle
        working-directory: apps/pwa/staff-admin/android
        env:
          ANDROID_VERSION_CODE: ${{ steps.version.outputs.version_code }}
          ANDROID_VERSION_NAME: ${{ steps.version.outputs.version_name }}
          ANDROID_KEYSTORE_PATH: ${{ github.workspace }}/apps/pwa/staff-admin/android/app/release.keystore
          ANDROID_KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          ANDROID_KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
          ANDROID_KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}
        run: |
          set -euo pipefail
          chmod +x gradlew
          ./gradlew clean bundleRelease --stacktrace

      - name: Rename bundle artifact
        id: bundle
        run: |
          set -euo pipefail
          OUTPUT_DIR="apps/pwa/staff-admin/android/app/build/outputs/bundle/release"
          BUNDLE_PREFIX="ibimina-staff-${{ steps.version.outputs.version_name }}"
          readarray -t MATCHING_BUNDLES < <(find "$OUTPUT_DIR" -maxdepth 1 -type f -name "${BUNDLE_PREFIX}-*.aab" -print)
          if [ "${#MATCHING_BUNDLES[@]}" -eq 0 ]; then
            echo "::error::Expected bundle matching ${BUNDLE_PREFIX}-*.aab not found in $OUTPUT_DIR"
            exit 1
          elif [ "${#MATCHING_BUNDLES[@]}" -gt 1 ]; then
            echo "::error::Multiple bundles matched ${BUNDLE_PREFIX}-*.aab in $OUTPUT_DIR: ${MATCHING_BUNDLES[*]}"
            exit 1
          fi
          SOURCE_BUNDLE="${MATCHING_BUNDLES[0]}"
          ARTIFACT_NAME="ibimina-staff-${{ steps.version.outputs.version_name }}-${{ steps.version.outputs.version_code }}.aab"
          mv "$SOURCE_BUNDLE" "$OUTPUT_DIR/$ARTIFACT_NAME"
          echo "path=$OUTPUT_DIR/$ARTIFACT_NAME" >> "$GITHUB_OUTPUT"

      - name: Upload signed bundle artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ format('ibimina-staff-aab-{0}', steps.version.outputs.version_name) }}
          path: ${{ steps.bundle.outputs.path }}
          retention-days: 30

      - name: Attach bundle to tag release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          files: ${{ steps.bundle.outputs.path }}
          name: Staff Android Bundle ${{ github.ref_name }}
          body: |
            ## Ibimina Staff Android Bundle
            *Version:* ${{ github.ref_name }}
            *Bundle:* `${{ steps.bundle.outputs.path }}`

            Generated automatically by the Android build workflow.
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
